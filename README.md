# TG DGN Bot - Telegram æ”¯ä»˜ä¸ä¼šå‘˜ç³»ç»Ÿ

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„ Telegram Bot æ”¯ä»˜ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

1. **TRC20 USDT å›ºå®šåœ°å€ + 3ä½å°æ•°å”¯ä¸€ç æ”¶æ¬¾**ï¼ˆIssue #1 âœ…ï¼‰
2. **Premium ä¼šå‘˜ç›´å……åŠŸèƒ½**ï¼ˆIssue #2 âœ…ï¼‰

æ”¯æŒé«˜å¹¶å‘ã€è‡ªåŠ¨è¿‡æœŸå›æ”¶ã€å®‰å…¨çš„æ”¯ä»˜å›è°ƒå¤„ç†å’Œè‡ªåŠ¨äº¤ä»˜ã€‚

## âœ… åŠŸèƒ½å®ç°çŠ¶æ€

### Issue #1: TRC20 USDT æ”¯ä»˜ç³»ç»Ÿ âœ…

- âœ… **ç»Ÿä¸€æ”¶æ¬¾åœ°å€é…ç½®** - æ”¯æŒ `.env` é…ç½® `USDT_TRC20_RECEIVE_ADDR`
- âœ… **å”¯ä¸€åç¼€ç”Ÿæˆ** - 0.001-0.999 åç¼€æ± ï¼Œæ”¯æŒå¹¶å‘ 300+ æ— å†²çª
- âœ… **é‡‘é¢ç²¾ç¡®è®¡ç®—** - ä½¿ç”¨æ•´æ•°åŒ–ï¼ˆÃ—10^6ï¼‰é¿å…æµ®ç‚¹è¯¯å·®
- âœ… **HMACç­¾åéªŒè¯** - ç¡®ä¿æ”¯ä»˜å›è°ƒå®‰å…¨æ€§
- âœ… **è®¢å•çŠ¶æ€ç®¡ç†** - PENDINGâ†’PAID å¹‚ç­‰æ›´æ–°
- âœ… **è‡ªåŠ¨è¿‡æœŸå›æ”¶** - Redis TTL è‡ªåŠ¨é‡Šæ”¾åç¼€
- âœ… **å®Œæ•´å•å…ƒæµ‹è¯•** - è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½

### Issue #2: Premium ä¼šå‘˜ç›´å…… âœ…

- âœ… **æ”¶ä»¶äººè§£æ** - æ”¯æŒ @usernameã€t.me/ é“¾æ¥ã€å»é‡å’Œè§„èŒƒåŒ–
- âœ… **å¥—é¤ç®¡ç†** - 3/6/12 ä¸ªæœˆå¥—é¤é…ç½®
- âœ… **å¯¹è¯æµç¨‹** - å®Œæ•´çš„ Telegram Bot å¯¹è¯å¼è´­ä¹°æµç¨‹
- âœ… **è‡ªåŠ¨äº¤ä»˜** - æ”¯ä»˜å®Œæˆåè‡ªåŠ¨è°ƒç”¨ Premium äº¤ä»˜æœåŠ¡
- âœ… **çŠ¶æ€è·Ÿè¸ª** - PENDINGâ†’PAIDâ†’DELIVERED/PARTIAL çŠ¶æ€ç®¡ç†
- âœ… **é”™è¯¯å¤„ç†** - éƒ¨åˆ†å¤±è´¥æ—¶è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… **æµ‹è¯•è¦†ç›–** - æ”¶ä»¶äººè§£æã€è®¢å•åˆ›å»ºã€äº¤ä»˜é€»è¾‘æµ‹è¯•

## ğŸ“ é¡¹ç›®ç»“æ„

```
tg_dgn_bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ payments/                    # æ”¯ä»˜æ¨¡å—ï¼ˆIssue #1ï¼‰
â”‚   â”‚   â”œâ”€â”€ suffix_manager.py       # åç¼€ç®¡ç†å™¨ (0.001-0.999æ± )
â”‚   â”‚   â”œâ”€â”€ amount_calculator.py    # é‡‘é¢è®¡ç®—å™¨ (æ•´æ•°åŒ–ç²¾åº¦)
â”‚   â”‚   â””â”€â”€ order.py               # è®¢å•çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ webhook/                     # Webhookæ¨¡å—ï¼ˆIssue #1ï¼‰
â”‚   â”‚   â””â”€â”€ trc20_handler.py        # TRC20å›è°ƒå¤„ç†å™¨ï¼ˆæ”¯æŒPremiumè‡ªåŠ¨äº¤ä»˜ï¼‰
â”‚   â”œâ”€â”€ premium/                     # Premiumæ¨¡å—ï¼ˆIssue #2ï¼‰
â”‚   â”‚   â”œâ”€â”€ handler.py              # Telegram Bot å¯¹è¯å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ recipient_parser.py     # æ”¶ä»¶äººè§£æå™¨
â”‚   â”‚   â””â”€â”€ delivery.py             # Premium äº¤ä»˜æœåŠ¡
â”‚   â”œâ”€â”€ config.py                   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ models.py                   # æ•°æ®æ¨¡å‹ï¼ˆæ”¯æŒPremiumè®¢å•ç±»å‹ï¼‰
â”‚   â”œâ”€â”€ signature.py                # HMACç­¾åéªŒè¯
â”‚   â””â”€â”€ webhook.py                  # FastAPI WebæœåŠ¡
â”œâ”€â”€ tests/                          # æµ‹è¯•æ¨¡å—
â”‚   â”œâ”€â”€ test_suffix_generator.py    # åç¼€ç”Ÿæˆå™¨æµ‹è¯•
â”‚   â”œâ”€â”€ test_payment_processor.py   # æ”¯ä»˜å¤„ç†æµ‹è¯•
â”‚   â”œâ”€â”€ test_amount_calculator.py   # é‡‘é¢è®¡ç®—æµ‹è¯•
â”‚   â”œâ”€â”€ test_trc20_handler.py      # TRC20å¤„ç†å™¨æµ‹è¯•
â”‚   â”œâ”€â”€ test_signature.py          # ç­¾åéªŒè¯æµ‹è¯•
â”‚   â”œâ”€â”€ test_integration.py        # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_recipient_parser.py   # æ”¶ä»¶äººè§£ææµ‹è¯•ï¼ˆPremiumï¼‰
â”‚   â”œâ”€â”€ test_premium_order.py      # Premiumè®¢å•æµ‹è¯•
â”‚   â””â”€â”€ test_premium_delivery.py   # Premiumäº¤ä»˜æµ‹è¯•
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ requirements.txt                # é¡¹ç›®ä¾èµ–
â””â”€â”€ verify_functionality.py        # åŠŸèƒ½éªŒè¯è„šæœ¬
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

å¿…è¦é…ç½®é¡¹ï¼š

```bash
BOT_TOKEN=your_telegram_bot_token
USDT_TRC20_RECEIVE_ADDR=TYourUSDTReceiveAddress  # æ³¢åœºUSDTæ”¶æ¬¾åœ°å€
WEBHOOK_SECRET=your_webhook_secret_key           # HMACç­¾åå¯†é’¥
REDIS_HOST=localhost                             # RedisæœåŠ¡å™¨
REDIS_PORT=6379
REDIS_DB=0
ORDER_TIMEOUT_MINUTES=30                         # è®¢å•è¿‡æœŸæ—¶é—´
```

### 2. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ FastAPI Web æœåŠ¡
python -m src.webhook

# æœåŠ¡å°†åœ¨ http://localhost:8000 å¯åŠ¨
```

### 4. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡ŒåŠŸèƒ½éªŒè¯
python verify_functionality.py

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆéœ€è¦RedisæœåŠ¡ï¼‰
python -m pytest tests/ -v

# è¿è¡Œæ ¸å¿ƒæµ‹è¯•ï¼ˆè·³è¿‡éœ€è¦Redisçš„é›†æˆæµ‹è¯•ï¼‰
python -m pytest tests/ -m "not redis" -v

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
python -m pytest tests/test_amount_calculator.py -v
python -m pytest tests/test_recipient_parser.py -v
python -m pytest tests/test_suffix_pool_redis.py -v  # Redisé›†æˆæµ‹è¯•
```

**æµ‹è¯•è¦†ç›–ï¼š**

- âœ… 80ä¸ªæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆå¯ç‹¬ç«‹è¿è¡Œï¼‰
- âœ… 21ä¸ª Redis é›†æˆæµ‹è¯•ï¼ˆéœ€è¦RedisæœåŠ¡ï¼‰
  - 8ä¸ªåŸæœ‰é›†æˆæµ‹è¯•
  - 13ä¸ªæ–°å¢åç¼€æ± çœŸå®æµ‹è¯•ï¼ˆå¹¶å‘ã€TTLã€ç§ŸæœŸå»¶é•¿ç­‰ï¼‰
- âœ… æ€»è®¡ **101 ä¸ªæµ‹è¯•**ï¼Œè¦†ç›–æ‰€æœ‰å…³é”®åŠŸèƒ½

**CI/CDï¼š**

- GitHub Actions è‡ªåŠ¨è¿è¡Œæ‰€æœ‰ 101 ä¸ªæµ‹è¯•
- ä½¿ç”¨çœŸå® Redis 7 æœåŠ¡ï¼ˆdocker serviceï¼‰
- Python 3.11 & 3.12 çŸ©é˜µæµ‹è¯•
- è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œè¿æ¥ç­‰å¾…

## ğŸ”§ API æ¥å£

### ä¸»è¦ç«¯ç‚¹

- `POST /webhook/trc20` - å¤„ç†TRC20æ”¯ä»˜å›è°ƒï¼ˆæ”¯æŒPremiumè‡ªåŠ¨äº¤ä»˜ï¼‰
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /stats` - è·å–è®¢å•ç»Ÿè®¡ä¿¡æ¯
- `POST /test/create-order` - åˆ›å»ºæµ‹è¯•è®¢å•
- `POST /test/simulate-payment` - æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒ

### Telegram Bot å‘½ä»¤

- `/premium` - å¼€å§‹ Premium ä¼šå‘˜è´­ä¹°æµç¨‹
- `/order_status <order_id>` - æŸ¥è¯¢è®¢å•çŠ¶æ€
- `/cancel` - å–æ¶ˆå½“å‰æ“ä½œ

### æ”¯ä»˜å›è°ƒæ ¼å¼

```json
{
  "order_id": "è®¢å•ID",
  "amount": 10.123,
  "txid": "äº¤æ˜“å“ˆå¸Œ",
  "timestamp": 1635724800,
  "signature": "HMACç­¾å",
  "order_type": "premium"  // å¯é€‰ï¼šæŒ‡å®šè®¢å•ç±»å‹
}
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### Issue #1: åˆ›å»ºæ”¯ä»˜è®¢å•

```python
from src.payments.order import order_manager

# åˆ›å»ºæ™®é€šè®¢å•
order = await order_manager.create_order(
    user_id=123456,
    base_amount=10.0
)

print(f"è®¢å•ID: {order.order_id}")
print(f"åº”ä»˜é‡‘é¢: {order.total_amount:.3f} USDT")  # ä¾‹å¦‚: 10.123 USDT
```

### Issue #2: Premium ä¼šå‘˜è´­ä¹°æµç¨‹

**1. ç”¨æˆ·å‘èµ·è´­ä¹°**

```
ç”¨æˆ·: /premium
Bot: æ˜¾ç¤ºå¥—é¤é€‰æ‹©ï¼ˆ3/6/12ä¸ªæœˆï¼‰
```

**2. é€‰æ‹©å¥—é¤**

```
ç”¨æˆ·: ç‚¹å‡» "3ä¸ªæœˆ - $10"
Bot: è¯·è¾“å…¥æ”¶ä»¶äººç”¨æˆ·å
```

**3. è¾“å…¥æ”¶ä»¶äºº**

```
ç”¨æˆ·: @alice
      @bob
      t.me/charlie
Bot: æ˜¾ç¤ºè®¢å•ç¡®è®¤
     - å¥—é¤ï¼š3ä¸ªæœˆ Premium
     - æ”¶ä»¶äººï¼š3äºº
     - åº”ä»˜ï¼š10.123 USDT
```

**4. ç¡®è®¤æ”¯ä»˜**

```
ç”¨æˆ·: ç‚¹å‡» "ç¡®è®¤æ”¯ä»˜"
Bot: è®¢å•å·²åˆ›å»ºï¼Œè¯·è½¬è´¦è‡³æŒ‡å®šåœ°å€
```

**5. è‡ªåŠ¨äº¤ä»˜**

```
ç”¨æˆ·æ”¯ä»˜å 2-5 åˆ†é’Ÿï¼š
- ç³»ç»Ÿæ£€æµ‹åˆ°æ”¯ä»˜
- è‡ªåŠ¨è°ƒç”¨ Premium äº¤ä»˜æœåŠ¡
- å‘æ”¶ä»¶äººå‘é€ Premium ç¤¼ç‰©
- æ›´æ–°è®¢å•çŠ¶æ€ä¸º DELIVERED/PARTIAL
```

### Premium API ç¤ºä¾‹

```python
from src.premium.handler import PremiumHandler
from src.premium.recipient_parser import RecipientParser
from src.models import OrderType

# è§£ææ”¶ä»¶äºº
text = "@alice @bob t.me/charlie"
recipients = RecipientParser.parse(text)
# ç»“æœ: ['alice', 'bob', 'charlie']

# åˆ›å»º Premium è®¢å•
order = await order_manager.create_order(
    user_id=123456,
    base_amount=10.0,
    order_type=OrderType.PREMIUM,
    premium_months=3,
    recipients=['alice', 'bob', 'charlie']
)
```

## ğŸ’¡ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

### 1. å”¯ä¸€åç¼€ç®¡ç†

- **åç¼€èŒƒå›´**: 0.001 - 0.999 (999ä¸ªå¯ç”¨)
- **å¹¶å‘å®‰å…¨**: Redis åˆ†å¸ƒå¼é”ç¡®ä¿å”¯ä¸€æ€§
- **è‡ªåŠ¨è¿‡æœŸ**: 30åˆ†é’ŸTTLè‡ªåŠ¨é‡Šæ”¾
- **åŸå­æ“ä½œ**: Luaè„šæœ¬ç¡®ä¿ä¸€è‡´æ€§

### 2. é‡‘é¢ç²¾åº¦å¤„ç†

```python
# é¿å…æµ®ç‚¹è¯¯å·®çš„æ•´æ•°åŒ–è®¡ç®—
micro_usdt = int(amount * 1000000)  # è½¬ä¸ºå¾®USDT
```

### 3. ç­¾åå®‰å…¨æœºåˆ¶

```python
# HMAC-SHA256 ç­¾åç”Ÿæˆ
signature = hmac.new(
    secret.encode('utf-8'),
    message.encode('utf-8'),
    hashlib.sha256
).hexdigest()
```

### 4. å¹‚ç­‰æ›´æ–°ä¿éšœ

- åŒä¸€è®¢å•å¤šæ¬¡å›è°ƒä»…å¤„ç†ä¸€æ¬¡
- çŠ¶æ€è½¬æ¢éªŒè¯ï¼ˆPENDINGâ†’PAIDï¼‰
- åŸå­æ€§çŠ¶æ€æ›´æ–°

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **å¹¶å‘æ”¯æŒ**: 300+ è®¢å•åŒæ—¶åˆ›å»ºæ— å†²çª
- **å“åº”æ—¶é—´**: < 100ms è®¢å•åˆ›å»º
- **ç²¾åº¦ä¿è¯**: 6ä½å°æ•°ç²¾åº¦ï¼ˆå¾®USDTçº§åˆ«ï¼‰
- **å¯ç”¨æ€§**: 999ä¸ªå”¯ä¸€åç¼€æ”¯æŒé«˜é¢‘äº¤æ˜“

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

- åç¼€åˆ†é…/é‡Šæ”¾æœºåˆ¶
- é‡‘é¢åŒ¹é…é€»è¾‘ï¼ˆæµ®ç‚¹ç²¾åº¦ï¼‰
- HMACç­¾åéªŒè¯
- è®¢å•çŠ¶æ€ç®¡ç†
- è¿‡æœŸæ¸…ç†æœºåˆ¶

### é›†æˆæµ‹è¯•

- ç«¯åˆ°ç«¯æ”¯ä»˜æµç¨‹
- å¹¶å‘åç¼€åˆ†é…
- å›è°ƒå¤„ç†éªŒè¯
- å®‰å…¨æ€§æµ‹è¯•

### åŠŸèƒ½éªŒè¯

```bash
# è¿è¡Œå®Œæ•´åŠŸèƒ½éªŒè¯
python verify_functionality.py
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **HMACç­¾å**: é˜²æ­¢å›è°ƒæ•°æ®ç¯¡æ”¹
- **æ—¶é—´æˆ³éªŒè¯**: é˜²æ­¢é‡æ”¾æ”»å‡»
- **åœ°å€æ ¼å¼éªŒè¯**: ç¡®ä¿æ³¢åœºåœ°å€åˆæ³•æ€§
- **é‡‘é¢èŒƒå›´æ£€æŸ¥**: é˜²æ­¢å¼‚å¸¸é‡‘é¢
- **å¹‚ç­‰æ€§ä¿æŠ¤**: é˜²æ­¢é‡å¤å¤„ç†

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

- **å¾®æœåŠ¡æ¶æ„**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºæ‰©å±•
- **Redisé›†ç¾¤**: æ”¯æŒæ°´å¹³æ‰©å±•
- **å¼‚æ­¥å¤„ç†**: æ”¯æŒé«˜å¹¶å‘è¯·æ±‚
- **é…ç½®é©±åŠ¨**: çµæ´»çš„ç¯å¢ƒé…ç½®

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åç¼€åˆ†é…å¤±è´¥**
   - æ£€æŸ¥Redisè¿æ¥çŠ¶æ€
   - ç¡®è®¤æ˜¯å¦è¾¾åˆ°999ä¸ªå¹¶å‘ä¸Šé™

2. **ç­¾åéªŒè¯å¤±è´¥**
   - æ£€æŸ¥WEBHOOK_SECRETé…ç½®
   - ç¡®è®¤æ•°æ®æ ¼å¼æ­£ç¡®

3. **è®¢å•çŠ¶æ€å¼‚å¸¸**
   - æ£€æŸ¥è®¢å•æ˜¯å¦è¿‡æœŸ
   - ç¡®è®¤çŠ¶æ€è½¬æ¢é€»è¾‘

### æ—¥å¿—è°ƒè¯•

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export LOG_LEVEL=DEBUG
python -m src.webhook
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤ä¿®æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- åˆ›å»º Issue
- å‘é€é‚®ä»¶è‡³é¡¹ç›®ç»´æŠ¤è€…
- å‚ä¸è®¨è®º
